#  一、毕业设计（论文）主要研究内容、进展情况及取得成果

## 研究内容

### 研究背景

很多基于Rust语言的教学操作系统（例如rCore）要部署到RISC-V开发板上，需要在操作系统中编写针对特定开发板的外设驱动模块，这样做会大大降低系统的可移植性。因此，该课题的目标是使用Rust语言以星光2开发板上的外设为例，编写驱动模块。每个驱动对应一个crate，作为库文件供其他操作系统调用。对于教学操作系统来说，只需在Cargo.toml中导入所需的驱动模块对应的crate即可，这样可以减轻系统的复杂性，提高其可移植性。

通过这种方式，开发人员可以将针对特定硬件的代码封装为独立的crate，使其易于在不同的项目中重用。这种模块化的设计使得教学操作系统更易于理解和维护，同时也为学习者提供了更清晰和可扩展的代码结构。此外，使用Rust语言的类型系统和所有权模型，可以在编译时捕获许多常见的错误，从而提高了代码的健壮性和可靠性。最终，这种基于Rust语言的驱动模块设计有助于促进教学操作系统的发展，并为学习者提供更好的学习和实践平台。

### 研究目标

利用Rust语言的模块化和异步支持的特点，可以将异步机制与底层设备结合起来，实现更高效的异步驱动，并且能够在多个操作系统中应用。

首先，通过使用Rust语言的模块化特性，可以将异步驱动分解为独立的模块，每个模块负责管理特定类型的设备或任务。这样的设计使得代码更易于理解、测试和维护，并且可以提高代码的可重用性和可移植性。

其次，利用Rust语言的异步支持，可以使用异步任务来处理设备的异步事件和IO操作，而不需要阻塞整个系统。通过异步编程模型，可以更高效地利用系统资源，并提高系统的响应性和性能。

将异步机制与底层设备结合起来，可以实现对设备的非阻塞访问和异步事件处理，从而提高了驱动的效率和性能。这种设计不仅可以在单个操作系统中应用，还可以轻松地移植到其他操作系统中，从而提高了代码的可移植性和通用性。

### 任务要求

理解 Rust 语⾔异步编程及其原理；

理解Rust语言的异步编程及其原理涉及到理解Rust中的Future和Async/Await机制。Future是一种代表异步计算结果的抽象，它可以表示一个尚未完成的异步操作，并且可以在后续的代码中进行处理。Async/Await是Rust中用于编写异步代码的语法糖，它们可以让编写异步代码更加简洁和易读，同时保持异步操作的性能。

理解 Rust 语⾔模块化思想；

理解Rust语言的模块化思想意味着将代码组织成独立的模块，每个模块负责特定的功能或任务。模块化设计可以提高代码的可维护性和可重用性，同时也可以降低代码的耦合度，使得代码更易于理解和测试。

理解⼀种设备的设计细节，思考其是否具有异步特性；

设计一个设备时，需要考虑其是否具有异步特性。例如，对于网络设备，异步特性可以用于处理网络请求和响应，以及处理网络中断和事件。而对于IO设备，异步特性可以用于非阻塞的IO操作，以提高系统的响应性和性能。因此，在设计设备时，需要考虑如何利用异步机制来实现设备的高效操作和事件处理。

在 linux 环境下或裸机环境下完成性能对⽐实验；

在Linux环境下或裸机环境下完成性能对比实验可以通过编写相同功能的同步和异步代码，并对它们进行性能测试来比较它们的性能差异。在Linux环境下，可以使用Rust的异步运行时库（如Tokio）来编写异步代码，并使用性能测试工具（如cargo-bench）来进行性能测试。在裸机环境下，可以编写裸机程序来测试异步操作的性能，比如使用异步IO来处理外设设备的事件和数据。通过这样的性能对比实验，可以评估异步代码在不同环境下的性能表现，并选择合适的编程模式来实现设备驱动。

### 具体任务

SD卡驱动：为星光2开发板上的外部存储卡槽编写驱动。

通用块设备接口：封装对底层块设备的访问，并提供读取和写入数据的方法。

多块设备支持：通过实现Trait支持多种类型的底层块设备，便于切换和适配不同的块设备。

缓存功能：使用结构体实现缓存对象用于存储最近访问的数据页，以提高对常用数据的访问速度。当需要读取数据时，先检查缓存中是否存在，如果存在则直接从缓存中获取数据，否则从底层块设备读取，并将数据缓存起来。

脏页管理：在对数据进行修改后，会将修改过的页标记为脏页，并在后续的刷新操作中将脏页写回到底层块设备中，以确保数据的一致性和持久性。

抽象接口：通过定义通用的接口和trait，实现了对底层块设备的抽象，使得上层代码可以统一操作不同类型的块设备，而无需关心底层具体实现的细节。

启动模块：编写一个通用的操作系统启动模块。

启动模块的编写旨在创造一个通用的操作系统启动模块。主要思路是将这个模块从操作系统中分离出来，形成一个 crate，以便导入和使用。在开始具体的工作之前，打算先学习 U-boot 和 tftpboot 相关内容。因为它们提供了关于启动过程和引导加载程序的重要信息。U-boot 是一个流行的开源引导加载程序，而 tftpboot 是一种使用 TFTP 协议进行网络引导的方法。通过学习这些内容，可以更好地了解如何设计和实现通用的启动模块。

块设备和文件系统的异步改进：将块设备的读写和文件系统改造成相应的异步形式。

将块设备的读写操作和文件系统改造成相应的异步形式是一个重要的任务。如果只是将块设备的读写操作改为异步，而文件系统仍然是同步的，那么在进行文件系统操作期间，仍然会阻塞线程或进程，从而降低了异步块设备驱动带来的性能优势。因此，为了充分发挥异步块设备驱动的性能优势，文件系统也需要改造成支持异步。

通过将文件系统改进为支持异步，将提高系统的吞吐量和性能：异步文件系统可以更有效地利用系统资源，减少等待时间，从而提高系统的整体性能和吞吐量。降低I/O延迟：异步文件系统可以在进行文件系统操作的同时执行其他任务，从而减少I/O操作的延迟，提高系统响应速度。充分利用系统资源：异步文件系统可以利用系统中的多个处理器核心或线程来并发执行多个文件系统操作，充分利用系统资源，提高并发性。所以将文件系统改造成支持异步可以有效地提高系统的性能和响应速度，是一个值得投入精力的重要改进任务。

## 进展情况

学习Rust语言的基础和进阶教程，了解Rust语言所有权机制，异步高并发，内存安全等语言特性。

学习rCore实验，阅读 rCore 的源代码，了解一个真实的操作系统内核是如何设计和实现的。

学习Embassy文档及示例代码，对异步运行时以及驱动的底层实现有了代码层面的了解。

学习星光2开发板相关内容。

## 取得成果

已成功将Ubuntu部署到星光2开发板上并能通过SSH正常工作。

已在qemu上正常运行Alien操作系统。

#  二、存在的问题和拟解决方案

## 问题和拟解决方案

riscv64-linux-musl-gcc: command not found：手动下载工具链：在RISC-V官方网站下载`riscv64-linux-musl-gcc`工具链的预编译版本。添加环境变量，修改Makefile重新编译项目。

qemu无法正常加载操作系统：疑似与本机的qemu存在冲突，尝试卸载本机qemu，无果后将Makefile中qemu的路径改为本机qemu的位置。

烧录到SD卡上：使用balenaetcher。

连接SSH不知道IP地址：插在路由器上用管理员账号查看设备地址。

## 待解决问题

无法验证操作系统是否正确安装：由于开发板即使不安装操作系统，接电后也会发热。且没有I/O设备可供用户交互，在正确启动操作系统并连接上SSH前，目前没找到方法能判断开发板的工作情况。

如果没有路由器辅助，无法得知IP地址：与前一个问题相似，若不知道IP地址，则无法SSH连接，也就无法控制开发板，也就无法在终端中获知IP地址。

# 三、下一步研究任务与进度安排

研究的目标是将操作系统中的块设备驱动从操作系统代码中分离出来，形成一个独立的 crate，并使其能够被不同的操作系统导入和使用。这个过程需要着重考虑可移植性，以确保它能够在多种操作系统上实现。（一周）

研究旨在将操作系统中的启动模块从操作系统代码中分离出来，形成一个独立的 crate，并确保它能够被不同的操作系统导入和使用。这个 boot 模块需要具备多种操作系统启动的能力。（一周）

究的重点是将块设备驱动改造为异步形式，并相应地修改文件系统以支持异步操作。这项工作涉及到对现有的块设备驱动和文件系统的重构，以使它们能够利用异步编程模型。这样的改造将使系统在处理块设备和文件系统操作时能够更好地利用系统资源，并提高整体性能。（两周）